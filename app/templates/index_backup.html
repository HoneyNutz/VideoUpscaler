{% extends "base.html" %}

{% block content %}
<!-- Section Container -->
<div id="section-container">
    <!-- Video Upscaler Section -->
    <div id="upscaler-section" class="section active">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-video text-indigo-400"></i>
                    Video Upscaler
                </h2>
                <p class="text-gray-400">Enhance your videos using AI-powered upscaling</p>
            </div>
            
            <div id="upload-container" class="dropzone p-12 text-center cursor-pointer mb-8">
                <div class="mb-6">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Drop your video here</h3>
                    <p class="text-gray-400 mb-4">or click to browse files</p>
                    
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.mp4</span>
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.avi</span>
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.mov</span>
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.mkv</span>
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.3gp</span>
                        <span class="px-3 py-1 bg-gray-700 rounded-full text-sm">.3g2</span>
                    </div>
                    
                    <p class="text-xs text-gray-500">Maximum file size: 2GB</p>
                </div>
                <input type="file" id="file-input" class="hidden" accept="video/*,.3gp,.3g2">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-3">Upscale Factor</label>
                    <select id="scale" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        <option value="2">2x Enhancement</option>
                        <option value="4" selected>4x Enhancement</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-3">AI Model</label>
                    <select id="model" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        <option value="RealESRGAN_x4plus" selected>RealESRGAN x4+ (General)</option>
                        <option value="realesr-general-x4v3">General v3 (Balanced)</option>
                        <option value="RealESRNet_x4plus">RealESRNet x4+ (Detail)</option>
                        <option value="RealESRGAN_x2plus">RealESRGAN x2+ (Fast)</option>
                        <option value="realesr-animevideov3">Anime Video v3</option>
                        <option value="RealESRGAN_x4plus_anime_6B">Anime Compact</option>
                    </select>
                </div>
            </div>
            
            <div id="model-description" class="mt-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-indigo-400 mt-1"></i>
                    <p class="text-sm text-gray-300">Best for 3GP mobile videos, photos, and real-world content</p>
                </div>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium mb-3">Save Location</label>
                <div class="flex gap-2">
                    <input type="text" id="save-location" placeholder="Choose save location (optional)" 
                           class="flex-1 p-3 rounded-lg bg-gray-800 border border-gray-600 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    <button id="browse-save-path" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i>
                        Browse
                    </button>
                    <input type="file" id="directory-picker" webkitdirectory style="display: none;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Section -->
    <div id="progress-section" class="section hidden">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-cog fa-spin text-indigo-400"></i>
                    Processing Video
                </h2>
                <p class="text-gray-400">AI enhancement in progress</p>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-lg font-semibold" id="status-text">Initializing...</span>
                    <span class="text-2xl font-bold text-indigo-400" id="progress-text">0%</span>
                </div>
                
                <div class="progress-bar mb-6">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                
                <div class="flex justify-center">
                    <button id="cancel-btn" class="btn btn-danger">
                        <i class="fas fa-stop"></i>
                        Cancel Processing
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Section -->
    <div id="success-section" class="section hidden">
        <div class="glass-card p-8 text-center">
            <div class="mb-8">
                <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                <h2 class="text-2xl font-bold mb-2 text-green-400">Enhancement Complete!</h2>
                <p class="text-gray-400">Your video has been successfully enhanced</p>
            </div>
            
            <div class="space-y-4">
                <button id="save-btn" class="btn btn-primary w-full">
                    <i class="fas fa-save"></i>
                    Save Enhanced Video
                </button>
                
                <button id="new-video-btn" class="btn btn-secondary w-full">
                    <i class="fas fa-plus"></i>
                    Process Another Video
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error Section -->
    <div id="error-section" class="section hidden">
        <div class="glass-card p-8 text-center">
            <div class="mb-8">
                <i class="fas fa-exclamation-triangle text-6xl text-red-400 mb-4"></i>
                <h2 class="text-2xl font-bold mb-2 text-red-400">Processing Failed</h2>
                <p class="text-gray-400 mb-4">An error occurred during video enhancement</p>
                <div class="bg-red-900/20 border border-red-700 rounded-lg p-4">
                    <p id="error-message" class="text-sm text-red-300"></p>
                </div>
            </div>
            
            <div class="space-y-4">
                <button id="retry-btn" class="btn btn-primary w-full">
                    <i class="fas fa-redo"></i>
                    Try Again
                </button>
                
                <button id="back-to-upload-btn" class="btn btn-secondary w-full">
                    <i class="fas fa-arrow-left"></i>
                    Back to Upload
                </button>
            </div>
        </div>
    </div>
    
    <!-- Batch Processing Section -->
    <div id="batch-section" class="section hidden">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-layer-group text-indigo-400"></i>
                    Batch Processing
                </h2>
                <p class="text-gray-400">Process multiple videos at once</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div id="batch-upload-container" class="dropzone p-8 text-center cursor-pointer">
                        <i class="fas fa-folder text-4xl text-gray-500 mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">Select Folder</h3>
                        <p class="text-gray-400 mb-4">Choose a folder containing videos to process</p>
                        <button id="batch-browse-btn" class="btn btn-primary">
                            <i class="fas fa-folder-open"></i>
                            Browse Folder
                        </button>
                        <input type="file" id="batch-directory-picker" webkitdirectory multiple style="display: none;">
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">File Extensions</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".mp4">
                                    <span class="text-sm">.mp4</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".avi">
                                    <span class="text-sm">.avi</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".mov">
                                    <span class="text-sm">.mov</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".mkv">
                                    <span class="text-sm">.mkv</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".3gp">
                                    <span class="text-sm">.3gp</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" checked class="rounded bg-gray-700 border-gray-600 text-indigo-600" value=".3g2">
                                    <span class="text-sm">.3g2</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Model</label>
                                <select id="batch-model" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white">
                                    <option value="RealESRGAN_x4plus">RealESRGAN x4+</option>
                                    <option value="realesr-general-x4v3">General x4v3</option>
                                    <option value="RealESRNet_x4plus">RealESRNet x4+</option>
                                    <option value="RealESRGAN_x2plus">RealESRGAN x2+</option>
                                    <option value="realesr-animevideov3">Anime Video v3</option>
                                    <option value="RealESRGAN_x4plus_anime_6B">Anime 6B</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Scale</label>
                                <select id="batch-scale" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white">
                                    <option value="2">2x</option>
                                    <option value="4" selected>4x</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="p-6 bg-gray-800/50 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Selected Files</h3>
                        <div id="batch-file-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-400 text-sm">No folder selected</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <button id="start-batch-btn" class="btn btn-primary w-full" disabled>
                                <i class="fas fa-play"></i>
                                Start Batch Processing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Models Section -->
    <div id="models-section" class="section hidden">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-brain text-indigo-400"></i>
                    AI Models
                </h2>
                <p class="text-gray-400">Available Real-ESRGAN models</p>
            </div>
            
            <div id="models-list" class="space-y-4">
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">RealESRGAN x4+</h3>
                            <p class="text-sm text-gray-400">Best for 3GP mobile videos and real-world content</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 67MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">4x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">General x4v3</h3>
                            <p class="text-sm text-gray-400">Balanced model with good quality and performance</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 67MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">4x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">RealESRNet x4+</h3>
                            <p class="text-sm text-gray-400">Enhanced detail preservation for high-quality images</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 67MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">4x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">RealESRGAN x2+</h3>
                            <p class="text-sm text-gray-400">Faster 2x upscaling for large videos and quick processing</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 67MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">2x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Anime Video v3</h3>
                            <p class="text-sm text-gray-400">Specialized for anime videos with temporal consistency</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 67MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">4x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Anime 6B</h3>
                            <p class="text-sm text-gray-400">Compact anime model - fastest processing</p>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs text-gray-500">Size: 17MB</span>
                                <span class="text-xs text-gray-500">•</span>
                                <span class="text-xs text-gray-500">4x upscaling</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 bg-green-600 rounded-full text-sm">Installed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Test Section -->
    <div id="test-section" class="section hidden">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-mobile-alt text-indigo-400"></i>
                    3GP Test
                </h2>
                <p class="text-gray-400">Test mobile video support</p>
            </div>
            
            <div class="text-center py-12">
                <button id="run-test-btn" class="btn btn-primary">
                    <i class="fas fa-play"></i>
                    Run 3GP Test
                </button>
            </div>
            
            <div id="test-output" class="mt-6 hidden">
                <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm">
                    <div id="test-log"></div>
                </div>
            </div>
        </div>
    </div>
    
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="btn btn-secondary">RealESRGAN x4+</button>
                    <button class="btn btn-secondary">General v3</button>
                    <button class="btn btn-secondary">RealESRNet x4+</button>
                    <button class="btn btn-secondary">RealESRGAN x2+</button>
                    <button class="btn btn-secondary">Anime Video v3</button>
                    <button class="btn btn-secondary">Anime Compact</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Storage Section -->
    <div id="storage-section" class="section hidden">
        <div class="glass-card p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    <i class="fas fa-hdd text-indigo-400"></i>
                    Storage Management
                </h2>
                <p class="text-gray-400">Manage disk space and files</p>
            </div>
            
            <div id="storage-info" class="mb-8">
                <div class="text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="text-gray-400 mt-2">Loading storage info...</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="cleanup-all" class="btn btn-danger">
                    <i class="fas fa-trash"></i>
                    Clean Everything
                </button>
                <button id="cleanup-uploads" class="btn btn-secondary">
                    <i class="fas fa-folder"></i>
                    Clean Uploads
                </button>
                <button id="cleanup-processed" class="btn btn-secondary">
                    <i class="fas fa-video"></i>
                    Clean Processed
                </button>
                <button id="cleanup-database" class="btn btn-secondary">
                    <i class="fas fa-database"></i>
                    Clean Database
                </button>
            </div>
        </div>
    </div>
    
    <!-- Help Section -->
    <div id="help-section" class="section hidden">
        <div class="glass-card p-8">
                        <i class="fas fa-lightbulb text-yellow-400"></i>
                        Quick Tips
                    </h3>
                    <ul class="text-sm text-gray-300 space-y-2">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-green-400 mt-1 text-xs"></i>
                            <span>Use RealESRGAN x4+ for 3GP/mobile videos</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-green-400 mt-1 text-xs"></i>
                            <span>Use Anime models for animated content</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-green-400 mt-1 text-xs"></i>
                            <span>2x scaling is faster than 4x</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check text-green-400 mt-1 text-xs"></i>
                            <span>Clean storage regularly to save space</span>
                        </li>
                    </ul>
                </div>
                
                <div class="p-6 bg-gray-800/50 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-file-video text-blue-400"></i>
                        Supported Formats
                    </h3>
                    <div class="grid grid-cols-3 gap-2">
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">MP4</span>
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">AVI</span>
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">MOV</span>
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">MKV</span>
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">3GP</span>
                        <span class="px-3 py-1 bg-gray-700 rounded text-center text-sm">3G2</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-6 bg-green-900/20 border border-green-700 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-mobile-alt text-green-400"></i>
                        3GP Optimization
                    </h3>
                    <p class="text-sm text-gray-300 mb-3">3GP files are automatically optimized for mobile video processing and converted to MP4 output for better compatibility.</p>
                    <div class="text-xs text-green-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        Automatic format conversion included
                    </div>
                </div>
                
                <div class="p-6 bg-purple-900/20 border border-purple-700 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-cogs text-purple-400"></i>
                        Performance Tips
                    </h3>
                    <p class="text-sm text-gray-300 mb-3">For large videos, the system automatically adjusts tile sizes and batch processing to optimize memory usage and processing speed.</p>
                    <div class="text-xs text-purple-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        Automatic optimization enabled
                    </div>
                </div>
            
            <div class="p-6 bg-blue-900/20 border border-blue-700 rounded-lg">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-terminal text-blue-400"></i>
                    CLI Commands
                </h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-300 mb-2">Start interactive main menu:</p>
                        <code class="block p-3 bg-gray-800 rounded text-sm text-green-400">uv run python main_menu.py</code>
                    </div>
                    <div>
                        <p class="text-sm text-gray-300 mb-2">Single file upscaling:</p>
                        <code class="block p-3 bg-gray-800 rounded text-sm text-green-400">uv run python video_upscaler.py input.mp4</code>
                    <div>
                        <p class="text-sm text-gray-300 mb-2">Batch processing:</p>
                        <code class="block p-3 bg-gray-800 rounded text-sm text-green-400">uv run python video_upscaler.py ./videos --batch</code>
                    </div>
            </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navigation
    const menuItems = document.querySelectorAll('.menu-item');
    const sections = document.querySelectorAll('.section');
    
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            const sectionId = this.dataset.section + '-section';
            
            // Update active menu item
            menuItems.forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding section
            sections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('Showing section:', sectionId);
            } else {
                console.error('Section not found:', sectionId);
            }
        });
    });
    
    // Video upscaler functionality
    const dropzone = document.getElementById('upload-container');
    const fileInput = document.getElementById('file-input');
    const progressSection = document.getElementById('progress-section');
    const successSection = document.getElementById('success-section');
    const errorSection = document.getElementById('error-section');
    const uploaderSection = document.getElementById('upscaler-section');
    
    const progressBar = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const statusText = document.getElementById('status-text');
    const errorMessage = document.getElementById('error-message');
    
    let currentTaskId = null;
    let outputFilename = null;
    
    // Initialize Socket.IO
    const socket = io();
    
    // File upload handling
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropzone.classList.add('dragover');
    }
    
    function unhighlight() {
        dropzone.classList.remove('dragover');
    }
    
    dropzone.addEventListener('drop', handleDrop, false);
    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
    }
    
    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];
            if (validateFile(file)) {
                uploadFile(file);
            }
        }
    }
    
    function validateFile(file) {
        const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'];
        const validExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.3gp', '.3g2'];
        
        const isValidType = validTypes.includes(file.type);
        const isValidExtension = validExtensions.some(ext => 
            file.name.toLowerCase().endsWith(ext)
        );
        
        if (!isValidType && !isValidExtension) {
            showError('Please select a valid video file');
            return false;
        }
        
        if (file.size > 2 * 1024 * 1024 * 1024) {
            showError('File size must be less than 2GB');
            return false;
        }
        
        return true;
    }
    
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('scale', document.getElementById('scale').value);
        formData.append('model', document.getElementById('model').value);
        
        // Add custom save path if specified
        const saveLocation = document.getElementById('save-location').value.trim();
        if (saveLocation) {
            formData.append('save_path', saveLocation);
        }
        
        // Switch to progress section
        showSection('progress-section');
        
        // Reset progress
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        statusText.textContent = 'Uploading...';
        
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            currentTaskId = data.task_id;
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message || 'Failed to upload file');
        });
    }
    
    // Progress updates via WebSocket
    socket.on('progress_update', function(data) {
        if (data.task_id !== currentTaskId) return;
        
        if (data.progress !== undefined) {
            const progress = Math.min(100, Math.max(0, data.progress));
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }
        
        if (data.status) {
            statusText.textContent = data.status;
        }
        
        if (data.status === 'completed') {
            fetch(`/status/${currentTaskId}`)
                .then(response => response.json())
                .then(taskData => {
                    outputFilename = taskData.output_filename;
                    showSection('success-section');
                })
                .catch(() => showSection('success-section'));
        } else if (data.status === 'failed') {
            showError(data.error || 'An unknown error occurred');
        }
    });
    
    // Cancel button
    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (currentTaskId) {
            fetch(`/api/tasks/${currentTaskId}`, { method: 'DELETE' })
                .then(() => {
                    showSection('upscaler-section');
                    currentTaskId = null;
                });
        }
    });
    
    // Save button
    document.getElementById('save-btn').addEventListener('click', function() {
        if (outputFilename) {
            const link = document.createElement('a');
            link.href = `/download/${outputFilename}`;
            link.download = outputFilename;
            link.click();
        }
    });
    
    // New video button
    document.getElementById('new-video-btn').addEventListener('click', function() {
        showSection('upscaler-section');
        currentTaskId = null;
        outputFilename = null;
        fileInput.value = '';
    });
    
    // Retry button
    document.getElementById('retry-btn').addEventListener('click', function() {
        showSection('upscaler-section');
    });
    
    // Back to upload button
    document.getElementById('back-to-upload-btn').addEventListener('click', function() {
        showSection('upscaler-section');
    });
    
    function showSection(sectionId) {
        sections.forEach(section => section.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
    }
    
    function showError(message) {
        errorMessage.textContent = message || 'An unknown error occurred';
        showSection('error-section');
    }
    
    // Model description updates
    const modelSelect = document.getElementById('model');
    const modelDescription = document.getElementById('model-description').querySelector('p');
    
    const modelDescriptions = {
        'RealESRGAN_x4plus': 'Best for 3GP mobile videos, photos, and real-world content',
        'realesr-general-x4v3': 'Balanced model with good quality and performance',
        'RealESRNet_x4plus': 'Enhanced detail preservation for high-quality images',
        'RealESRGAN_x2plus': 'Faster 2x upscaling for large videos and quick processing',
        'realesr-animevideov3': 'Specialized for anime videos with temporal consistency',
        'RealESRGAN_x4plus_anime_6B': 'Compact anime model - fastest processing'
    };
    
    modelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        modelDescription.textContent = modelDescriptions[selectedModel] || 'AI model for video enhancement';
    });
    
    // Storage management
    function loadStorageInfo() {
        const storageInfo = document.getElementById('storage-info');
        
        fetch('/api/storage/info')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                storageInfo.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button type="button" id="browse-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg border border-gray-600 transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>Browse
                        </button>
                        <input type="file" id="directory-picker" webkitdirectory style="display: none;" />
                        <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700 text-center">
                            <i class="fas fa-folder text-2xl text-blue-400 mb-2"></i>
                            <div class="text-lg font-semibold">${data.uploads?.count || '0'}</div>
                            <div class="text-sm text-gray-400">Uploads (${data.uploads?.size || '0 B'})</div>
                        </div>
                        <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700 text-center">
                            <i class="fas fa-video text-2xl text-green-400 mb-2"></i>
                            <div class="text-lg font-semibold">${data.processed?.count || '0'}</div>
                            <div class="text-sm text-gray-400">Processed (${data.processed?.size || '0 B'})</div>
                        </div>
                        <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700 text-center">
                            <i class="fas fa-database text-2xl text-purple-400 mb-2"></i>
                            <div class="text-lg font-semibold">${data.database?.count || '0'}</div>
                            <div class="text-sm text-gray-400">Database Records</div>
                        </div>
                    </div>
                    <div class="text-center p-4 bg-indigo-900/20 border border-indigo-700 rounded-lg">
                        <div class="text-xl font-bold text-indigo-400">Total: ${data.total?.size || '0 B'}</div>
                    </div>
                `;
            })
            .catch(error => {
                storageInfo.innerHTML = `
                    <div class="text-center py-4 text-red-400">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to load storage info</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            });
    }
    
    // Load storage info when storage section is shown
    document.querySelector('[data-section="storage"]').addEventListener('click', loadStorageInfo);
    
    // Cleanup buttons
    function performCleanup(type) {
        fetch('/api/cleanup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            loadStorageInfo(); // Refresh storage info
        })
        .catch(error => {
            console.error('Cleanup error:', error);
        });
    }
    
    document.getElementById('cleanup-all').addEventListener('click', () => performCleanup('all'));
    document.getElementById('cleanup-uploads').addEventListener('click', () => performCleanup('uploads'));
    document.getElementById('cleanup-processed').addEventListener('click', () => performCleanup('processed'));
    document.getElementById('cleanup-database').addEventListener('click', () => performCleanup('database'));
    
    // Test functionality
    document.getElementById('run-test-btn').addEventListener('click', function() {
        const testOutput = document.getElementById('test-output');
        const testLog = document.getElementById('test-log');
        
        testOutput.classList.remove('hidden');
        testLog.innerHTML = '<div class="text-indigo-400">Running 3GP test...</div>';
        
        // Simulate test output
        setTimeout(() => {
            testLog.innerHTML = `
                <div class="text-green-400">✓ 3GP format support: OK</div>
                <div class="text-green-400">✓ Mobile optimization: OK</div>
                <div class="text-green-400">✓ MP4 conversion: OK</div>
                <div class="text-green-400">✓ Test completed successfully</div>
            `;
        }, 2000);
    });
    
    // Directory picker functionality
    const browseBtn = document.getElementById('browse-save-path');
    const directoryPicker = document.getElementById('directory-picker');
    const saveLocationInput = document.getElementById('save-location');
    
    if (browseBtn && directoryPicker && saveLocationInput) {
        browseBtn.addEventListener('click', function() {
            directoryPicker.click();
        });
        
        directoryPicker.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                // Get the directory path from the first file
                const firstFile = e.target.files[0];
                const dirPath = firstFile.webkitRelativePath.split('/')[0];
                saveLocationInput.value = dirPath;
            }
        });
    }
    
    // Batch processing functionality
    const batchBrowseBtn = document.getElementById('batch-browse-btn');
    const batchDirectoryPicker = document.getElementById('batch-directory-picker');
    const batchFileList = document.getElementById('batch-file-list');
    const startBatchBtn = document.getElementById('start-batch-btn');
    
    if (batchBrowseBtn && batchDirectoryPicker) {
        batchBrowseBtn.addEventListener('click', function() {
            batchDirectoryPicker.click();
        });
        
        batchDirectoryPicker.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const videoFiles = files.filter(file => {
                const ext = file.name.toLowerCase().split('.').pop();
                return ['mp4', 'avi', 'mov', 'mkv', '3gp', '3g2'].includes(ext);
            });
            
            if (videoFiles.length > 0) {
                batchFileList.innerHTML = videoFiles.map(file => 
                    `<div class="flex items-center justify-between p-2 bg-gray-700 rounded">
                        <span class="text-sm">${file.name}</span>
                        <span class="text-xs text-gray-400">${(file.size / 1024 / 1024).toFixed(1)}MB</span>
                    </div>`
                ).join('');
                startBatchBtn.disabled = false;
            } else {
                batchFileList.innerHTML = '<p class="text-gray-400 text-sm">No video files found</p>';
                startBatchBtn.disabled = true;
            }
        });
    }
    
    // Model download functionality
    function downloadModel(modelName) {
        const downloadStatus = document.getElementById('download-status');
        const downloadMessage = document.getElementById('download-message');
        
        downloadStatus.classList.remove('hidden');
        downloadMessage.textContent = `Downloading ${modelName}...`;
        
        // Simulate download (in real implementation, this would call the backend)
        setTimeout(() => {
            downloadMessage.textContent = `${modelName} downloaded successfully!`;
            setTimeout(() => {
                downloadStatus.classList.add('hidden');
            }, 2000);
        }, 3000);
    }
    
    // Make downloadModel function globally available
    window.downloadModel = downloadModel;
</script>
{% endblock %}
